<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Selling Price API Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffebee; border-left: 4px solid #f44336; }
        .success { background: #e8f5e9; border-left: 4px solid #4caf50; }
        .warning { background: #fff3e0; border-left: 4px solid #ff9800; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
        button { background: #2196f3; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 3px; cursor: pointer; }
        button:hover { background: #1976d2; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>Selling Price API Fix Test</h1>
    
    <div>
        <h3>Test Item Selling Price API</h3>
        <input type="text" id="itemNo" placeholder="Item Number (e.g., ITEM001)" value="ITEM001">
        <input type="text" id="priceCategory" placeholder="Price Category (optional)">
        <button onclick="testItemPrice()">Test Item Price API</button>
    </div>
    
    <div id="results"></div>

    <script>
        function addResult(title, content, type = 'success') {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `<h4>${title}</h4><pre>${content}</pre>`;
            resultsDiv.appendChild(resultDiv);
        }

        function testItemPrice() {
            const itemNo = document.getElementById('itemNo').value || 'ITEM001';
            const priceCategory = document.getElementById('priceCategory').value;
            
            let url = `./sellingprice/listprice.php?no=${encodeURIComponent(itemNo)}`;
            if (priceCategory) {
                url += `&priceCategoryName=${encodeURIComponent(priceCategory)}`;
            }
            
            addResult('Testing...', `Fetching from: ${url}`, 'warning');
            
            fetch(url)
                .then(response => {
                    console.log('Response status:', response.status);
                    console.log('Response headers:', [...response.headers.entries()]);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new Error(`Expected JSON, got: ${contentType}`);
                    }
                    
                    return response.json();
                })
                .then(data => {
                    console.log('API Response:', data);
                    
                    let resultText = `Success: ${data.success}\\n`;
                    resultText += `Message: ${data.message}\\n\\n`;
                    
                    if (data.success) {
                        resultText += 'Request Info:\\n';
                        if (data.request_info) {
                            Object.keys(data.request_info).forEach(key => {
                                resultText += `  ${key}: ${data.request_info[key]}\\n`;
                            });
                        }
                        
                        resultText += '\\nResponse Data:\\n';
                        if (data.data) {
                            if (data.data.d && data.data.d.unitPrice) {
                                resultText += `  Unit Price: ${data.data.d.unitPrice}\\n`;
                            }
                            resultText += `  Full Data: ${JSON.stringify(data.data, null, 2)}`;
                        }
                        
                        addResult('âœ… Selling Price API Test - SUCCESS', resultText, 'success');
                    } else {
                        resultText += `Error Code: ${data.error_code || 'N/A'}\\n`;
                        resultText += '\\nRequest Info:\\n';
                        if (data.request_info) {
                            Object.keys(data.request_info).forEach(key => {
                                resultText += `  ${key}: ${data.request_info[key]}\\n`;
                            });
                        }
                        
                        addResult('âŒ Selling Price API Test - FAILED', resultText, 'error');
                    }
                })
                .catch(error => {
                    console.error('API Error:', error);
                    let errorText = `Error: ${error.message}\\n`;
                    errorText += `URL: ${url}\\n`;
                    errorText += `Time: ${new Date().toLocaleString()}`;
                    
                    addResult('âŒ Selling Price API Test - ERROR', errorText, 'error');
                });
        }

        // Auto-run test on page load
        window.onload = function() {
            setTimeout(() => {
                addResult('ðŸ”§ Fix Applied', 
                    'Applied fixes:\\n' +
                    '1. Added missing helper methods to AccurateAPI class:\\n' +
                    '   - getSessionId()\\n' +
                    '   - getCurrentAccessToken()\\n' +
                    '   - getBaseUrl()\\n' +
                    '   - getItemSellingPrice()\\n\\n' +
                    '2. Updated listprice.php to use AccurateAPI methods\\n' +
                    '3. Replaced manual cURL calls with proper API wrapper\\n\\n' +
                    'Now testing...', 
                    'warning');
                
                setTimeout(testItemPrice, 1000);
            }, 500);
        };
    </script>
</body>
</html>